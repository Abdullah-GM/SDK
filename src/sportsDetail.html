<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="./style.css">
</head>

<body>
    <div class="sports-page">
        <div class="mktdetail-listing">

        </div>
    </div>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    
   <script>
    const socket = io('https://preprodvicsdk.bettech.live/', {
    reconnectionAttempts: 1000,
    transports: ["websocket"]
});

let subscribedMarkets = new Set();

document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const eventId = urlParams.get('eid');
    
    if (!eventId) {
        showNoEventMessage();
        return;
    }

    socket.on('odds', (oddsData) => {
        updateLiveOdds(oddsData);
    });

    socket.on('update', (updateData) => {
    console.log(updateData);
    
        updateLiveOdds(updateData);
    });
    socket.on('connect', () => {
        socket.emit('market', { type: "list", data: eventId }, (marketCallback) => {
            if (!marketCallback?.data?.[eventId]) {
                showNoEventMessage();
                return;
            }
            populateActiveMarkets(marketCallback);
        });
    });

    function showNoEventMessage() {
        const container = document.querySelector('.mktdetail-listing');
        if (!container) return;
        
        container.innerHTML = `
            <div class="no-event-message">
                <h2>No Event Found</h2>
                <p>The requested event could not be found or is no longer available.</p>
            </div>
        `;
    }

    function populateActiveMarkets(marketData) {
        const container = document.querySelector('.mktdetail-listing');
        if (!container) return;

        container.innerHTML = '';

        const allMarkets = marketData.data[eventId];
        const activeMarkets = allMarkets.filter(market => market.s === true && market.go === false);

        if (activeMarkets.length === 0) {
            container.innerHTML = '<div class="no-markets">No active markets available</div>';
            return;
        }

        subscribeToMarkets(activeMarkets);

        const marketsByType = groupMarketsByType(activeMarkets);
        Object.keys(marketsByType).forEach(marketType => {
            const marketSection = createMarketSection(marketType, marketsByType[marketType]);
            container.appendChild(marketSection);
        });

        console.log('Market Data:', marketData);
    }

    function subscribeToMarkets(markets) {
        const marketIds = markets.map(market => market.mid).filter(Boolean);
        
        if (marketIds.length === 0) return;

        const marketIdsString = marketIds.join(',');
        
        socket.emit('subscribe', marketIdsString, (response) => {
            if (response.status === 1) {
                marketIds.forEach(id => subscribedMarkets.add(id));
                console.log('Subscribed to markets:', marketIdsString);
            }
        });
    }

    function updateLiveOdds(oddsData) {
        if (!oddsData?.data) return;

        Object.keys(oddsData.data).forEach(marketId => {
            const marketUpdate = oddsData.data[marketId];
            updateMarketOdds(marketId, marketUpdate);
        });
    }

    function updateMarketOdds(marketId, marketData) {
        const oddsElements = document.querySelectorAll(`[data-market="${marketId}"]`);
        
        oddsElements.forEach(element => {
            const oddType = element.getAttribute('data-type');
            updateOddElement(element, oddType, marketData);
        });
    }

    function updateOddElement(element, oddType, marketData) {
        const [type, position] = oddType.split('-');
        const posIndex = parseInt(position) - 1;

        if (marketData.oc && marketData.oc[posIndex]) {
            const outcome = marketData.oc[posIndex];
            const oddsValue = type === 'back' ? outcome.od : outcome.lay;
            const price = outcome.price || '--';

            element.querySelector('.odd-val').textContent = oddsValue || '--';
            element.querySelector('.odd-price').textContent = `${price}`;
            
            element.classList.add('blink');
            setTimeout(() => element.classList.remove('blink'), 1000);
        }
    }

    function groupMarketsByType(markets) {
        const grouped = {};
        markets.forEach(market => {
            const type = market.ty || 'other';
            if (!grouped[type]) grouped[type] = [];
            grouped[type].push(market);
        });
        return grouped;
    }

    function createMarketSection(marketType, markets) {
        const section = document.createElement('div');
        section.className = 'mktdetail-list has-tooltip';
        
        section.innerHTML = `
            <div class="mktdetail-list-hdr">
                <div class="mktdetail-list-ttl">
                    <span class="mktdetail-list-cat">${formatMarketType(marketType)}</span>
                </div>
                <div class="mktdetail-list-odds">
                    <div class="mktdetail-list-odd type-back">Back</div>
                    <div class="mktdetail-list-odd type-lay">Lay</div>
                </div>
            </div>
            <div class="mktdetail-list-content">
                <div class="mktdtl-desk-wrp">
                    ${markets.map(market => createMarketHTML(market)).join('')}
                </div>
            </div>
        `;
        
        return section;
    }

    function createMarketHTML(market) {
        // ✅ DISPLAY EACH RUNNER IN SEPARATE ROWS
        if (market.r && market.r.length > 0) {
            return market.r.map(runner => `
                <div class="mktdetail-list-topmatches" data-market-id="${market.mid}" data-runner-id="${runner.rid}">
                    <div class="team-wpr">
                        <div class="team-name">
                            <div>${runner.na}</div>
                        </div>
                    </div>
                    <div class="matches-odds-wrp">
                        <div class="odds-count-wrp">
                            <div class="top-matches-count type-back">
                                ${createOddsHTML('back', market.mid)}
                            </div>
                            <div class="top-matches-count type-lay">
                                ${createOddsHTML('lay', market.mid)}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        } else {
            // For markets without runners
            return `
                <div class="mktdetail-list-topmatches" data-market-id="${market.mid}">
                    <div class="team-wpr">
                        <div class="team-name">
                            <div>${market.na}</div>
                        </div>
                    </div>
                    <div class="matches-odds-wrp">
                        <div class="odds-count-wrp">
                            <div class="top-matches-count type-back">
                                ${createOddsHTML('back', market.mid)}
                            </div>
                            <div class="top-matches-count type-lay">
                                ${createOddsHTML('lay', market.mid)}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
    }

    function createOddsHTML(type, marketId) {
        return [1, 2, 3].map(position => `
            <div class="match-odd ${type}-bg" data-market="${marketId}" data-type="${type}-${position}">
                <div class="odd-val">--</div>
                <div class="odd-price">₹ --</div>
            </div>
        `).join('');
    }

    function formatMarketType(type) {
        const typeMap = {
            'match-odd': 'Match Odds',
            'session': 'Session Markets',
            'fancy': 'Fancy Markets',
            'bookmaker': 'Bookmaker'
        };
        return typeMap[type] || type.replace(/-/g, ' ').toUpperCase();
    }
});
   </script>

</body>

</html>