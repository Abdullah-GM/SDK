<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sports Betting Odds</title>
    <link rel="stylesheet" href="./style.css">
</head>

<body>
    <div class="sports-page">
        <div class="mktdetail-listing"></div>
    </div>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

    <script>
        const socket = io('https://preprodvicsdk.bettech.live/', {
            reconnectionAttempts: 1000,
            transports: ["websocket"]
        });

        let subscribedMarkets = new Set();
        let marketTypeMap = {};

        document.addEventListener('DOMContentLoaded', function () {
            const urlParams = new URLSearchParams(window.location.search);
            const eventId = urlParams.get('eid');

            if (!eventId) {
                showNoEventMessage();
                return;
            }

            socket.on('update', function(updateData) {
                console.log('ðŸ“¤ Update received:', updateData);
                
                if (updateData.data && Array.isArray(updateData.data)) {
                    updateData.data.forEach(item => {
                        if (item.data && item.data.mid) {
                            updateMarketOdds(item.data.mid, item.data);
                        }
                    });
                } else if (updateData.market && updateData.market.mid) {
                    fetchMarketData(updateData.market.mid);
                }
            });

            socket.on('connect', () => {
                socket.emit('market', { type: "list", data: eventId }, (marketCallback) => {
                    if (!marketCallback?.data?.[eventId]) {
                        showNoEventMessage();
                        return;
                    }
                    populateActiveMarkets(marketCallback);
                });
            });

            function fetchMarketData(marketId) {
                socket.emit('market', { type: "data", data: marketId }, (marketData) => {
                    if (marketData && marketData.data) {
                        updateMarketOdds(marketId, marketData.data);
                    }
                });
            }

            function showNoEventMessage() {
                const container = document.querySelector('.mktdetail-listing');
                if (!container) return;
                container.innerHTML = `
                <div class="no-event-message">
                    <h2>No Event Found</h2>
                    <p>The requested event could not be found or is no longer available.</p>
                </div>
            `;
            }

            function populateActiveMarkets(marketData) {
                const container = document.querySelector('.mktdetail-listing');
                if (!container) return;

                container.innerHTML = '';
                const allMarkets = marketData.data[eventId];
                const activeMarkets = allMarkets.filter(market => market.s === true && market.go === false);

                if (activeMarkets.length === 0) {
                    container.innerHTML = '<div class="no-markets">No active markets available</div>';
                    return;
                }

                buildMarketTypeMap(activeMarkets);
                subscribeToMarkets(activeMarkets);

                const marketsByType = groupMarketsByType(activeMarkets);
                Object.keys(marketsByType).forEach(marketType => {
                    const marketSection = createMarketSection(marketType, marketsByType[marketType]);
                    container.appendChild(marketSection);
                });

                activeMarkets.forEach(market => {
                    if (market.mid) {
                        fetchMarketData(market.mid);
                    }
                });
            }

            function buildMarketTypeMap(markets) {
                marketTypeMap = {};
                const uniqueTypes = [...new Set(markets.map(market => market.ty))];
                
                const commonMappings = {
                    'match-odd': 'Match Odds',
                    'session': 'Session Markets',
                    'fancy': 'Fancy Markets',
                    'bookmaker': 'Bookmaker',
                    'tied-match': 'Tied Match',
                    'completed-match': 'Completed Match'
                };
                
                uniqueTypes.forEach(type => {
                    if (!type) {
                        marketTypeMap['other'] = 'Other Markets';
                        return;
                    }
                    marketTypeMap[type] = commonMappings[type] || 
                        type.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
                });
            }

            function subscribeToMarkets(markets) {
                const marketIds = markets.map(market => market.mid).filter(Boolean);
                if (marketIds.length === 0) return;

                const marketIdsString = marketIds.join(',');
                socket.emit('subscribe', marketIdsString, (response) => {
                    if (response.status === 1) {
                        marketIds.forEach(id => subscribedMarkets.add(id));
                    }
                });
            }

            function updateMarketOdds(marketId, marketData) {
                console.log('ðŸ”„ Updating market:', marketId, marketData);
                
                const oddsElements = document.querySelectorAll(`[data-market="${marketId}"]`);
                if (oddsElements.length === 0) return;

                oddsElements.forEach(element => {
                    const oddType = element.getAttribute('data-type');
                    updateOddElement(element, oddType, marketData);
                });
            }

            function updateOddElement(element, oddType, marketData) {
                const [type, position] = oddType.split('-');
                
                // Check if market has hyphen in ID - PRIMARY LOGIC
                const hasHyphen = marketData.mid && marketData.mid.includes('-');
                
                if (hasHyphen) {
                    // HYPHEN LOGIC: Market with hyphen is always 2-box
                    if (marketData.r && marketData.r.length > 0) {
                        updateTwoBoxMarketWithRunners(element, type, parseInt(position), marketData);
                    } else {
                        updateTwoBoxMarketDirect(element, type, parseInt(position), marketData);
                    }
                } else {
                    // NO HYPHEN LOGIC: Check data structure for 6-box vs 2-box
                    // SCENARIO 1: 6-box market (has b1, b2, b3 in runners)
                    if (marketData.r && marketData.r.length > 0 && marketData.r[0].b1 !== undefined) {
                        updateSixBoxMarket(element, type, parseInt(position), marketData);
                    }
                    // SCENARIO 2: 2-box market with runners (has b, l in runners)
                    else if (marketData.r && marketData.r.length > 0 && marketData.r[0].b !== undefined) {
                        updateTwoBoxMarketWithRunners(element, type, parseInt(position), marketData);
                    }
                    // SCENARIO 3: Direct market properties (no runners array)
                    else {
                        updateTwoBoxMarketDirect(element, type, parseInt(position), marketData);
                    }
                }
            }

            // SCENARIO 1: 6-box market
            function updateSixBoxMarket(element, type, position, marketData) {
                const marketElement = element.closest('[data-runner-id]');
                if (!marketElement) return;

                const runnerId = marketElement.getAttribute('data-runner-id');
                const runner = marketData.r.find(r => r.rid == runnerId);
                if (!runner) return;

                const oddsValue = runner[`${type}${position}`];
                const priceValue = runner[`${type === 'back' ? 'br' : 'lr'}${position}`];

                if (oddsValue !== undefined && oddsValue !== null) {
                    // Show "0" instead of "--" for zero odds
                    const displayOdds = oddsValue === "0" ? "0" : oddsValue;
                    const displayPrice = (priceValue === 0 || priceValue === "0") ? "--" : priceValue;
                    
                    element.querySelector('.odd-val').textContent = displayOdds;
                    element.querySelector('.odd-price').textContent = displayPrice;
                    highlightUpdate(element);
                }
            }

            // SCENARIO 2: 2-box market with runners
            function updateTwoBoxMarketWithRunners(element, type, position, marketData) {
                const marketElement = element.closest('[data-runner-id]');
                if (!marketElement) return;

                const runnerId = marketElement.getAttribute('data-runner-id');
                const runner = marketData.r.find(r => r.rid == runnerId);
                if (!runner) return;

                // Only update position 1 for 2-box markets
                if (position === 1) {
                    const oddsValue = type === 'back' ? runner.b : runner.l;
                    const priceValue = type === 'back' ? runner.br : runner.lr;

                    if (oddsValue !== undefined && oddsValue !== null) {
                        // Show "0" instead of "--" for zero odds
                        const displayOdds = oddsValue === 0 || oddsValue === "0" ? "0" : oddsValue;
                        const displayPrice = (priceValue === 0 || priceValue === "0") ? "--" : priceValue;
                        
                        element.querySelector('.odd-val').textContent = displayOdds;
                        element.querySelector('.odd-price').textContent = displayPrice;
                        highlightUpdate(element);
                    }
                }
            }

            // SCENARIO 3: Direct market properties
            function updateTwoBoxMarketDirect(element, type, position, marketData) {
                // Only update position 1 for direct markets
                if (position === 1) {
                    const oddsValue = type === 'back' ? marketData.b : marketData.l;
                    const priceValue = type === 'back' ? marketData.br : marketData.lr;

                    if (oddsValue !== undefined && oddsValue !== null) {
                        // Show "0" instead of "--" for zero odds
                        const displayOdds = oddsValue === 0 || oddsValue === "0" ? "0" : oddsValue;
                        const displayPrice = (priceValue === 0 || priceValue === "0") ? "--" : priceValue;
                        
                        element.querySelector('.odd-val').textContent = displayOdds;
                        element.querySelector('.odd-price').textContent = displayPrice;
                        highlightUpdate(element);
                    }
                }
            }

            function highlightUpdate(element) {
                element.classList.add('blink');
                setTimeout(() => element.classList.remove('blink'), 1000);
            }

            function groupMarketsByType(markets) {
                const grouped = {};
                markets.forEach(market => {
                    const type = market.ty || 'other';
                    if (!grouped[type]) grouped[type] = [];
                    grouped[type].push(market);
                });
                return grouped;
            }

            function createMarketSection(marketType, markets) {
                const section = document.createElement('div');
                
                // Check if any market in this section has hyphen in ID
                const hasHyphenMarkets = markets.some(market => market.mid && market.mid.includes('-'));
                
                section.className = hasHyphenMarkets ? 
                    'mktdetail-list has-tooltip one-backlay-item' : 
                    'mktdetail-list has-tooltip';

                section.innerHTML = `
                <div class="mktdetail-list-hdr">
                    <div class="mktdetail-list-ttl">
                        <span class="mktdetail-list-cat">${formatMarketType(marketType)}</span>
                    </div>
                    <div class="mktdetail-list-odds">
                        <div class="mktdetail-list-odd type-back">Back</div>
                        <div class="mktdetail-list-odd type-lay">Lay</div>
                    </div>
                </div>
                <div class="mktdetail-list-content">
                    <div class="mktdtl-desk-wrp">
                        ${markets.map(market => createMarketHTML(market)).join('')}
                    </div>
                </div>
            `;

                return section;
            }

            function createMarketHTML(market) {
                // Check if market has hyphen in ID
                const hasHyphen = market.mid && market.mid.includes('-');
                
                if (hasHyphen) {
                    // HYPHEN LOGIC: Always create 2-box layout for markets with hyphen
                    if (market.r && market.r.length > 0) {
                        // Market with runners - create 2-box for each runner
                        return market.r.map(runner => `
                            <div class="mktdetail-list-topmatches" data-market-id="${market.mid}" data-runner-id="${runner.rid}">
                                <div class="team-wpr">
                                    <div class="team-name">
                                        <div>${runner.na || 'Runner ' + runner.rid}</div>
                                    </div>
                                </div>
                                <div class="matches-odds-wrp">
                                    <div class="odds-count-wrp">
                                        <div class="top-matches-count type-back">
                                            ${createTwoBoxOddsHTML('back', market.mid)}
                                        </div>
                                        <div class="top-matches-count type-lay">
                                            ${createTwoBoxOddsHTML('lay', market.mid)}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        // Market without runners - create simple 2-box
                        return `
                            <div class="mktdetail-list-topmatches" data-market-id="${market.mid}">
                                <div class="team-wpr">
                                    <div class="team-name">
                                        <div>${market.na || 'Market'}</div>
                                    </div>
                                </div>
                                <div class="matches-odds-wrp">
                                    <div class="odds-count-wrp">
                                        <div class="top-matches-count type-back">
                                            ${createTwoBoxOddsHTML('back', market.mid)}
                                        </div>
                                        <div class="top-matches-count type-lay">
                                            ${createTwoBoxOddsHTML('lay', market.mid)}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                } else {
                    // NO HYPHEN LOGIC: Use data structure to determine layout
                    // SCENARIO 3: Direct market properties (no runners)
                    if (!market.r || !Array.isArray(market.r) || market.r.length === 0) {
                        return `
                        <div class="mktdetail-list-topmatches" data-market-id="${market.mid}">
                            <div class="team-wpr">
                                <div class="team-name">
                                    <div>${market.na || 'Market'}</div>
                                </div>
                            </div>
                            <div class="matches-odds-wrp">
                                <div class="odds-count-wrp">
                                    <div class="top-matches-count type-back">
                                        ${createTwoBoxOddsHTML('back', market.mid)}
                                    </div>
                                    <div class="top-matches-count type-lay">
                                        ${createTwoBoxOddsHTML('lay', market.mid)}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    }
                    
                    // SCENARIO 1 & 2: Markets with runners - create 6-box layout
                    return market.r.map(runner => `
                        <div class="mktdetail-list-topmatches" data-market-id="${market.mid}" data-runner-id="${runner.rid}">
                            <div class="team-wpr">
                                <div class="team-name">
                                    <div>${runner.na || 'Runner ' + runner.rid}</div>
                                </div>
                            </div>
                            <div class="matches-odds-wrp">
                                <div class="odds-count-wrp">
                                    <div class="top-matches-count type-back">
                                        ${createSixBoxOddsHTML('back', market.mid)}
                                    </div>
                                    <div class="top-matches-count type-lay">
                                        ${createSixBoxOddsHTML('lay', market.mid)}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            }

            function createSixBoxOddsHTML(type, marketId) {
                return [1, 2, 3].map(position => `
                    <div class="match-odd ${type}-bg" data-market="${marketId}" data-type="${type}-${position}">
                        <div class="odd-val">--</div>
                        <div class="odd-price">--</div>
                    </div>
                `).join('');
            }

            function createTwoBoxOddsHTML(type, marketId) {
                return `
                    <div class="match-odd ${type}-bg" data-market="${marketId}" data-type="${type}-1">
                        <div class="odd-val">--</div>
                        <div class="odd-price">--</div>
                    </div>
                `;
            }

            function formatMarketType(type) {
                return marketTypeMap[type] || 
                    (type ? type.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ') : 'Other Markets');
            }
        });
    </script>

</body>

</html>