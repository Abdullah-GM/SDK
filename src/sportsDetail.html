<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="./style.css">
</head>

<body>
    <div class="sports-page">
        <div class="mktdetail-listing">

        </div>
    </div>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <!-- <script>
        document.addEventListener('DOMContentLoaded', () => {
            const tabs = document.querySelector('.sports-tabrow');
            const tabItems = document.querySelectorAll('.sports-tab-item');
            const cards = document.querySelectorAll('.mktdetail-tab');

            tabs.addEventListener('click', (e) => {
                const tab = e.target.closest('.sports-tab-item');
                if (!tab) return;

                const selectedTab = tab.dataset.tab;

                // Update active tab
                tabItems.forEach(item => {
                    const isActive = item === tab;
                    item.classList.toggle('active', isActive);
                    item.setAttribute('aria-selected', isActive);
                });

                // Show/hide corresponding content
                cards.forEach(card => {
                    if (card.id === selectedTab) {
                        card.style.display = ''; // let CSS handle display type
                    } else {
                        card.style.display = 'none';
                    }
                });

                console.log('Active tab:', selectedTab);
            });
        });

        // detail.js - No storage needed
        const socket = io('https://preprodvicsdk.bettech.live/', {
            reconnectionAttempts: 1000,
            transports: ["websocket"]
        });

        document.addEventListener('DOMContentLoaded', function () {
            console.log('=== DETAIL PAGE LOADED ===');

            // Get event ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            const eventId = urlParams.get('eid');

            console.log('Event ID from URL:', eventId);

            // ✅ FETCH FRESH MARKET DATA DIRECTLY
            socket.on('connect', () => {
                console.log('Socket connected on detail page');

                // Fetch market data for this specific event
                socket.emit('market', { type: "list", data: eventId }, (marketCallback) => {
                    console.log('✅ Market data for event:', marketCallback);
                    displayEventDetail(eventId, marketCallback);
                });
            });

            function displayEventDetail(eventId, marketData) {
                console.log('=== DISPLAYING EVENT DETAIL ===');
                console.log('Event ID:', eventId);
                console.log('Market Data:', marketData);
            }
        });
    </script> -->


    <script>
        // ✅ OPTIMIZED DETAIL.JS WITH EVENT NOT FOUND HANDLING
        const socket = io('https://preprodvicsdk.bettech.live/', {
            reconnectionAttempts: 1000,
            transports: ["websocket"]
        });

        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== DETAIL PAGE LOADED ===');
            
            const urlParams = new URLSearchParams(window.location.search);
            const eventId = urlParams.get('eid');
            
            console.log('Event ID from URL:', eventId);

            // ✅ CHECK IF EVENT ID EXISTS
            if (!eventId) {
                showNoEventMessage();
                return;
            }

            socket.on('connect', () => {
                console.log('Socket connected on detail page');
                
                socket.emit('market', { type: "list", data: eventId }, (marketCallback) => {
                    console.log('✅ Market data received');
                    
                    // ✅ CHECK IF MARKET DATA EXISTS FOR THIS EVENT
                    if (!marketCallback?.data?.[eventId]) {
                        showNoEventMessage();
                        return;
                    }
                    
                    populateActiveMarkets(marketCallback);
                });
            });

            function showNoEventMessage() {
                const container = document.querySelector('.mktdetail-listing');
                if (!container) return;
                
                container.innerHTML = `
                    <div class="no-event-message">
                        <h2>No Event Found</h2>
                        <p>The requested event could not be found or is no longer available.</p>
                        <p>Please check the event ID and try again.</p>
                    </div>
                `;
            }

            function populateActiveMarkets(marketData) {
                const container = document.querySelector('.mktdetail-listing');
                if (!container) return;

                container.innerHTML = '';

                const allMarkets = marketData.data[eventId];
                
                // ✅ FILTER: Only active markets
                const activeMarkets = allMarkets.filter(market => 
                    market.s === true && market.go === false
                );

                console.log(`Total markets: ${allMarkets.length}, Active markets: ${activeMarkets.length}`);

                if (activeMarkets.length === 0) {
                    container.innerHTML = '<div class="no-markets">No active markets available for this event</div>';
                    return;
                }

                // Group and render markets
                const marketsByType = groupMarketsByType(activeMarkets);
                Object.keys(marketsByType).forEach(marketType => {
                    const marketSection = createMarketSection(marketType, marketsByType[marketType]);
                    container.appendChild(marketSection);
                });
                console.log('Market Data:', marketData);
            }

            function groupMarketsByType(markets) {
                const grouped = {};
                markets.forEach(market => {
                    const type = market.ty || 'other';
                    if (!grouped[type]) grouped[type] = [];
                    grouped[type].push(market);
                });
                return grouped;
            }

            function createMarketSection(marketType, markets) {
                const section = document.createElement('div');
                section.className = 'mktdetail-list has-tooltip';
                
                section.innerHTML = `
                    <div class="mktdetail-list-hdr">
                        <div class="mktdetail-list-ttl">
                            <span class="mktdetail-list-cat">${formatMarketType(marketType)}</span>
                        </div>
                        <div class="mktdetail-list-odds">
                            <div class="mktdetail-list-odd type-back">Back</div>
                            <div class="mktdetail-list-odd type-lay">Lay</div>
                        </div>
                    </div>
                    <div class="mktdetail-list-content">
                        <div class="mktdtl-desk-wrp">
                            ${markets.map(market => createMarketHTML(market)).join('')}
                        </div>
                    </div>
                `;
                
                return section;
            }

            function createMarketHTML(market) {
                const teamName = market.r && market.r.length > 0 
                    ? market.r.map(runner => runner.na).join(' vs ')
                    : market.na;

                return `
                    <div class="mktdetail-list-topmatches">
                        <div class="team-wpr">
                            <div class="team-name">
                                <div>${teamName}</div>
                            </div>
                        </div>
                        <div class="matches-odds-wrp">
                            <div class="odds-count-wrp">
                                <div class="top-matches-count type-back">
                                    ${createOddsHTML('back')}
                                </div>
                                <div class="top-matches-count type-lay">
                                    ${createOddsHTML('lay')}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            function createOddsHTML(type) {
                return `
                    <div class="match-odd ${type}-bg">
                        <div class="odd-val">--</div>
                        <div class="odd-price">₹ --</div>
                    </div>
                    <div class="match-odd ${type}-bg">
                        <div class="odd-val">--</div>
                        <div class="odd-price">₹ --</div>
                    </div>
                    <div class="match-odd ${type}-bg">
                        <div class="odd-val">--</div>
                        <div class="odd-price">₹ --</div>
                    </div>
                `;
            }

            function formatMarketType(type) {
                const typeMap = {
                    'match-odd': 'Match Odds',
                    'session': 'Session Markets',
                    'fancy': 'Fancy Markets',
                    'bookmaker': 'Bookmaker'
                };
                return typeMap[type] || type.replace(/-/g, ' ').toUpperCase();
            }
        });
    </script>

</body>

</html>